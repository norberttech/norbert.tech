<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Testing Stimulus - minimalistic approach</title>
    <meta property="og:title" content="Testing Stimulus - minimalistic approach" />
    <meta name="twitter:title" content="Testing Stimulus - minimalistic approach" >

    <meta name="description" content="Testing Stimulus controllers with absolute minimalistic approach. With only built in test runner, assert and JSDOM library">
    <meta property="og:description" content="Testing Stimulus controllers with absolute minimalistic approach. With only built in test runner, assert and JSDOM library">
    <meta name="twitter:description" content="Testing Stimulus controllers with absolute minimalistic approach. With only built in test runner, assert and JSDOM library">

    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://norbert.tech/blog/2024-09-20/testing-stimulus-minimalistic-approach" />
    <meta property="og:image" content="https://norbert.tech/assets/images/avatar-8f3c52c37f20d07c5e1631e1512bdeca.jpeg" />
    <meta property="og:image:type" content="image/svg+xml" />
    <meta property="og:image:alt" content="Norbert Orzechowicz - Personal Website" />

    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://norbert.tech/blog/2024-09-20/testing-stimulus-minimalistic-approach" />
    <meta name="twitter:image" content="https://norbert.tech/assets/images/avatar-8f3c52c37f20d07c5e1631e1512bdeca.jpeg">
    <meta name="twitter:site" content="@norbert_tech" />
    <meta name="twitter:creator" content="@norbert_tech" />

    <link rel="apple-touch-icon" sizes="180x180" href="https://norbert.tech/assets/images/favicons/apple-touch-icon-9cae7ee880b4fe0bd755d300e1bca71e.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://norbert.tech/assets/images/favicons/favicon-32x32-b7a4ad4b584ab95534144e071f0e8587.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://norbert.tech/assets/images/favicons/favicon-16x16-154ca21abc06ae116c8d7ffc5713c000.png">
    <link rel="shortcut icon" href="https://norbert.tech/assets/images/favicons/favicon-db409885df78dea389e6d0b036da382c.ico">

            <style>
            @import url('https://fonts.googleapis.com/css2?family=Cabin:ital,wght@0,400..700;1,400..700&display=swap');
        </style>
        <link rel="stylesheet" href="https://norbert.tech/assets/styles/app-870b4343dac08b00de391119a2f0c758.css">
    
            
<script type="importmap">
{
    "imports": {
        "app": "https://norbert.tech/assets/app-930adf3462cf9ab60908eb1b74cf7ca7.js",
        "@oddbird/popover-polyfill": "https://norbert.tech/assets/vendor/@oddbird/popover-polyfill/popover-polyfill.index-7979d53637476aa204f709644aed2c19.js",
        "https://norbert.tech/assets/bootstrap.js": "https://norbert.tech/assets/bootstrap-d78d7e12c819dedf89372fb4824c072d.js",
        "htmx.org": "https://norbert.tech/assets/vendor/htmx.org/htmx.org.index-023ae86a082913526422a6063298f898.js",
        "iconify-icon": "https://norbert.tech/assets/vendor/iconify-icon/iconify-icon.index-8a41e423576dc2d752509fd455f508c1.js",
        "@symfony/stimulus-bundle": "https://norbert.tech/assets/@symfony/stimulus-bundle/loader-9311b8ea36bad0f6168e687b4d6dee73.js",
        "@hotwired/stimulus": "https://norbert.tech/assets/vendor/@hotwired/stimulus/stimulus.index-304681764684182e6662e0931532ed91.js",
        "https://norbert.tech/assets/@symfony/stimulus-bundle/controllers.js": "https://norbert.tech/assets/@symfony/stimulus-bundle/controllers-11c35dc7f11bbd855b8108888f18f9b7.js",
        "https://norbert.tech/assets/controllers/hello_controller.js": "https://norbert.tech/assets/controllers/hello_controller-55882fcad241d2bea50276ea485583bc.js",
        "https://norbert.tech/assets/controllers/syntax_highlight_controller.js": "https://norbert.tech/assets/controllers/syntax_highlight_controller-ae10e4cee8b4dedbf232536d05654062.js",
        "https://norbert.tech/assets/controllers/clipboard_controller.js": "https://norbert.tech/assets/controllers/clipboard_controller-6aefa8a9dec3271dae2f05b464bf9204.js",
        "highlight.js/lib/core": "https://norbert.tech/assets/vendor/highlight.js/lib/core-760145ef158caabe84ca07686407d093.js",
        "highlight.js/lib/languages/php": "https://norbert.tech/assets/vendor/highlight.js/lib/languages/php-c0eb2105c14097e8a5a1e9a767e8ac95.js",
        "highlight.js/styles/github-dark.min.css": "data:application/javascript,document.head.appendChild%28Object.assign%28document.createElement%28%22link%22%29%2C%7Brel%3A%22stylesheet%22%2Chref%3A%22https%3A%2F%2Fnorbert.tech%2Fassets%2Fvendor%2Fhighlight.js%2Fstyles%2Fgithub-dark.min-4b46e20f66f76e35d6454ca4f09b57c3.css%22%7D%29%29",
        "@fontsource-variable/cabin/index.min.css": "data:application/javascript,document.head.appendChild%28Object.assign%28document.createElement%28%22link%22%29%2C%7Brel%3A%22stylesheet%22%2Chref%3A%22https%3A%2F%2Fnorbert.tech%2Fassets%2Fvendor%2F%40fontsource-variable%2Fcabin%2Findex.min-08e34691d22388e6974e6cb2bfbcbfd0.css%22%7D%29%29",
        "clipboard": "https://norbert.tech/assets/vendor/clipboard/clipboard.index-925566f98181665b5a61fea1bcd9033d.js",
        "highlight.js/lib/languages/shell": "https://norbert.tech/assets/vendor/highlight.js/lib/languages/shell-664215791af27581e04813723523a355.js",
        "highlight.js/lib/languages/json": "https://norbert.tech/assets/vendor/highlight.js/lib/languages/json-9ac51ad2a97f9ce56b2f309eb64d7b04.js",
        "highlight.js/lib/languages/twig": "https://norbert.tech/assets/vendor/highlight.js/lib/languages/twig-0f3c6d18c0368650898b432b7bcf672a.js",
        "highlight.js/lib/languages/sql": "https://norbert.tech/assets/vendor/highlight.js/lib/languages/sql-09f80640dd6fe9bed6ff4eb255b13f08.js",
        "highlight.js/lib/languages/javascript": "https://norbert.tech/assets/vendor/highlight.js/lib/languages/javascript-100f963be02a503f0531e497103ff398.js",
        "highlight.js/lib/languages/xml": "https://norbert.tech/assets/vendor/highlight.js/lib/languages/xml-a2295112e12d4d01f257d59e1cfa676d.js"
    }
}
</script>
<!-- ES Module Shims: Import maps polyfill for modules browsers without import maps support -->
<script async src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js"></script>
<link rel="modulepreload" href="https://norbert.tech/assets/app-930adf3462cf9ab60908eb1b74cf7ca7.js">
<link rel="modulepreload" href="https://norbert.tech/assets/vendor/@oddbird/popover-polyfill/popover-polyfill.index-7979d53637476aa204f709644aed2c19.js">
<link rel="modulepreload" href="https://norbert.tech/assets/bootstrap-d78d7e12c819dedf89372fb4824c072d.js">
<link rel="modulepreload" href="https://norbert.tech/assets/vendor/htmx.org/htmx.org.index-023ae86a082913526422a6063298f898.js">
<link rel="modulepreload" href="https://norbert.tech/assets/vendor/iconify-icon/iconify-icon.index-8a41e423576dc2d752509fd455f508c1.js">
<link rel="modulepreload" href="https://norbert.tech/assets/@symfony/stimulus-bundle/loader-9311b8ea36bad0f6168e687b4d6dee73.js">
<link rel="modulepreload" href="https://norbert.tech/assets/vendor/@hotwired/stimulus/stimulus.index-304681764684182e6662e0931532ed91.js">
<link rel="modulepreload" href="https://norbert.tech/assets/@symfony/stimulus-bundle/controllers-11c35dc7f11bbd855b8108888f18f9b7.js">
<link rel="modulepreload" href="https://norbert.tech/assets/controllers/hello_controller-55882fcad241d2bea50276ea485583bc.js">
<script type="module">import 'app';</script>
    </head>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-153657381-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-153657381-1');
</script>
<body class="scroll-smooth text-black relative min-h-screen pb-16">
    <div class="sticky top-0 max-h-screen overflow-y-auto bg-white py-2 px-2 border-b border-gray-500 z-[9999] print:hidden">
        <div class="grid grid-cols-2 sm:mx-auto sm:max-w-screen-2xl md:px-4">
            <div class="text-left">
                <a href="/" class="text-lg">
                    norbert.tech
                </a>
            </div>
            <div class="text-right">
                <a href="/consulting" class="text-lg inline-flex items-center space-x-1 md:mr-4 mr-2">
                    <iconify-icon icon="lineicons:consulting" class="mr-1"></iconify-icon> Consulting
                </a>
                <a href="/blog" class="text-lg inline-flex items-center space-x-1">
                    <iconify-icon icon="ooui:articles-ltr" class="mr-1"></iconify-icon> Blog
                </a>
            </div>
        </div>
    </div>
    
    <main class="mx-auto max-w-screen-2xl mb-4 md:pt-4 px-4 lg:px-0">
        <div class="mx-auto max-w-screen-xl px-2">
    <a href="/blog" class="text-blue-500 hover:underline">Back to blog</a>
</div>
<article class="blog-post px-2 py-5 sm:px-4 mx-auto max-w-screen-xl">
    <h1 class="font-bold text-4xl mb-2" id="title">Testing Stimulus - minimalistic approach</h1>
<div class="mb-2">
    <small class="text-sm">Posted on September 20, 2024 00:00</small>
</div>
<div class="mb-4">
            <small><span class="badge badge-info">stimulus</span></small>
            <small><span class="badge badge-info">testing</span></small>
    </div>
<p>
    While writing this article, Stimulus did not yet provide clear documentation on testing Stimulus controllers.<br/>
    The approach presented below is very minimalist and introduces almost no dependencies into our system. It does not require any dedicated test runner or transpiler.
</p>
<p>
    Letâ€™s start by outlining the problem. Assume we want to test the behavior of the following controller.
</p>

<pre><code class="code-html" data-controller="syntax-highlight">&lt;div data-controller=&quot;test&quot;&gt;
    &lt;a id=&quot;test-button&quot; data-action=&quot;click-&gt;test#test&quot; href=&quot;#&quot;&gt;Open Modal&lt;/a&gt;
    &lt;span data-test-target=&quot;output&quot;&gt;&lt;/span&gt;
&lt;/div&gt;
</code></pre>

<pre><code class="code-javascript" data-controller="syntax-highlight">class extends Controller {
    static targets = ["output"];

    test() {
        this.outputTarget.textContent = "Hello World!";
    }
})</code></pre>
<p>
    The task of this controller is to place the text "Hello World!" inside a span element (marked as the output target).
</p>
<p>
    Letâ€™s start by preparing all the dependencies. Weâ€™re taking an absolutely minimalist approach,
    and the only dependency weâ€™ll introduce into our system (apart from <a href="https://nodejs.org/en/download/package-manager" target="_blank">NodeJS v20</a> and <a href="https://github.com/hotwired/stimulus" target="_blank">Stimulus</a>) is <a href="https://github.com/jsdom/jsdom" target="_blank">JSDOM</a>.
</p>
<p>
    This is how the <code>package.json</code> file should look:
</p>
    <pre><code class="code-json" data-controller="syntax-highlight">{
  "name": "stimulus-test",
  "version": "1.0.0",
  "description": "",
  "scripts": {},
  "author": "",
  "dependencies": {
    "@hotwired/stimulus": "^3.2.2",
    "jsdom": "^25.0.0"
  }
}</code></pre>

<p>
    Before we start writing the tests, we need to prepare the runtime environment.<br/>
    Stimulus runs in the browser, which means the browser provides it with many global objects/functions that Stimulus internally uses.
</p>
<p>
    To recreate this environment, we will prepare a simple <code>createWindow</code> function, whose task will be to globally expose the <code>Window</code> object and a few others,
    which come directly from the <code>JSDOM</code> library.
</p>
<p>
    This is how the <code>bootstrap.js</code> file might look.
</p>
<pre><code class="code-javascript" data-controller="syntax-highlight">const JSDOM = require("jsdom").JSDOM;

/**
 * Creates a global window object with the given HTML.
 * Expose all global objects used by Stimulus.
 *
 * @param {string} html
 */
function createWindow(html) {
    global.window = new JSDOM(html).window;
    global.document = window.document;
    global.MutationObserver = window.MutationObserver;
    global.KeyboardEvent = window.KeyboardEvent;
    global.MouseEvent = window.MouseEvent;
    global.Element = window.Element;
    global.Node = window.Node;
}

module.exports = createWindow;</code></pre>
<p>
    The <code>createWindow</code> function expects HTML code that will be placed in the virtual body object of the virtual
    document object nested in the virtual window element, which is exposed to the runtime environment via <code>global.window</code>.
</p>
<p>
    Okay, now we have all the necessary building blocks, and we can proceed with writing the actual test.
</p>
<pre><code class="code-javascript" data-controller="syntax-highlight">const { test }  = require(&#039;node:test&#039;);
const assert = require(&#039;node:assert&#039;).strict;
const { Application, Controller } = require(&#039;@hotwired/stimulus&#039;);
const createWindow = require(&#039;./bootstrap&#039;);

test(&#039;connecting modal controller&#039;, async () =&gt; {

    createWindow(`
        &lt;div data-controller=&quot;test&quot;&gt;
            &lt;a id=&quot;test-button&quot; data-action=&quot;click-&gt;test#test&quot; href=&quot;#&quot;&gt;Open Modal&lt;/a&gt;
            &lt;span data-test-target=&quot;output&quot;&gt;&lt;/span&gt;
        &lt;/div&gt;
    `);

    const application = Application.start();
    application.register(&quot;test&quot;, class extends Controller {
        static targets = [&#039;output&#039;];

        connect() {
        }

        test() {
            this.outputTarget.textContent = &quot;Hello World!&quot;;
        }
    });

    await new Promise(resolve =&gt; setTimeout(resolve, 0));

    document.getElementById(&#039;test-button&#039;).dispatchEvent(new MouseEvent(&#039;click&#039;));

    assert.equal(
        document.querySelector(&#039;[data-test-target=&quot;output&quot;]&#039;).textContent,
        &quot;Hello World!&quot;
    );
});
</code></pre>
<p>
    Letâ€™s take a look at the individual elements of this test.
</p>
<p>
    Since Stimulus controllers are registered asynchronously, we need to wait a little while.
    To do this, after registering the controller, we will introduce an artificial delay.
</p>
<pre><code class="code-javascript" data-controller="syntax-highlight">const application = Application.start();
application.register(&quot;test&quot;, OurController);

await new Promise(resolve =&gt; setTimeout(resolve, 0));
</code></pre>
<p>
    To ensure that everything is working properly, we can add <code>console.log()</code> to the <code>connect()</code> method inside our controller.
    If after running the test using <code>node --test ./test.js</code>, we see our message in the console,
    it means that Stimulus and the controller have been correctly registered.
</p>
<p>
    This essentially concludes the preparation phase. Everything beyond this point is just the logic of our test.
</p>
<p>
    The logic involves simulating a click on the element and checking via assertions whether the content of the target element has changed.
</p>
<p>
    In order to execute our test, please run following command in the cli:
</p>
    <pre><code class="code-shell" data-controller="syntax-highlight">node --test ./test.js</code></pre>

</article>
<div class="mb-2 mx-auto max-w-screen-xl text-center">
    <script src="https://giscus.app/client.js"
            data-repo="norberttech/norbert.tech"
            data-repo-id="MDEwOlJlcG9zaXRvcnkyMjQ0MDQwNDA="
            data-category="Comments"
            data-category-id="DIC_kwDODWAiSM4CionD"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="0"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="light"
            data-lang="en"
            crossorigin="anonymous"
            async>
    </script>
</div>
    </main>

    <footer class="p-4 bg-sky-50 absolute bottom-0 w-full">
        <div class="mx-auto max-w-screen-2xl text-center">
            <a href="/">by @norbert_tech</a>
        </div>
    </footer>
</body>
</html>