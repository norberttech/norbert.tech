<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Home Assistant - Accessing Historical Statistics</title>
    <meta property="og:title" content="Home Assistant - Accessing Historical Statistics" />
    <meta name="twitter:title" content="Home Assistant - Accessing Historical Statistics" >

    <meta name="description" content="How to access historical statistics in home assistant.">
    <meta property="og:description" content="How to access historical statistics in home assistant.">
    <meta name="twitter:description" content="How to access historical statistics in home assistant.">

    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://norbert.wip/blog/2024-08-07/home-assistant-historical-statistics" />
    <meta property="og:image" content="https://norbert.wip/assets/images/avatar-8f3c52c37f20d07c5e1631e1512bdeca.jpeg" />
    <meta property="og:image:type" content="image/svg+xml" />
    <meta property="og:image:alt" content="Norbert Orzechowicz - Personal Website" />

    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://norbert.wip/blog/2024-08-07/home-assistant-historical-statistics" />
    <meta name="twitter:image" content="https://norbert.wip/assets/images/avatar-8f3c52c37f20d07c5e1631e1512bdeca.jpeg">
    <meta name="twitter:site" content="@norbert_tech" />
    <meta name="twitter:creator" content="@norbert_tech" />

    <link rel="apple-touch-icon" sizes="180x180" href="https://norbert.wip/assets/images/favicons/apple-touch-icon-9cae7ee880b4fe0bd755d300e1bca71e.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://norbert.wip/assets/images/favicons/favicon-32x32-b7a4ad4b584ab95534144e071f0e8587.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://norbert.wip/assets/images/favicons/favicon-16x16-154ca21abc06ae116c8d7ffc5713c000.png">
    <link rel="shortcut icon" href="https://norbert.wip/assets/images/favicons/favicon-db409885df78dea389e6d0b036da382c.ico">

            <style>
            @import url('https://fonts.googleapis.com/css2?family=Cabin:ital,wght@0,400..700;1,400..700&display=swap');
        </style>
        <link rel="stylesheet" href="https://norbert.wip/assets/styles/app-2c777d5d9b072da12caf7e93de9cf774.css">
    
            
<script type="importmap">
{
    "imports": {
        "app": "https://norbert.wip/assets/app-930adf3462cf9ab60908eb1b74cf7ca7.js",
        "@oddbird/popover-polyfill": "https://norbert.wip/assets/vendor/@oddbird/popover-polyfill/popover-polyfill.index-8f1adf02d2fe31ba0e133b65d1faeece.js",
        "https://norbert.wip/assets/bootstrap.js": "https://norbert.wip/assets/bootstrap-d78d7e12c819dedf89372fb4824c072d.js",
        "htmx.org": "https://norbert.wip/assets/vendor/htmx.org/htmx.org.index-9c972342e01d7cc4830a1976259158c7.js",
        "iconify-icon": "https://norbert.wip/assets/vendor/iconify-icon/iconify-icon.index-4471e3c6a0bda14753f1327106be2b63.js",
        "@symfony/stimulus-bundle": "https://norbert.wip/assets/@symfony/stimulus-bundle/loader-9311b8ea36bad0f6168e687b4d6dee73.js",
        "@hotwired/stimulus": "https://norbert.wip/assets/vendor/@hotwired/stimulus/stimulus.index-6f73d85e0fa2bcb3802562288e3f3042.js",
        "https://norbert.wip/assets/@symfony/stimulus-bundle/controllers.js": "https://norbert.wip/assets/@symfony/stimulus-bundle/controllers-30e149621baab8220e8ae00cc40a4a23.js",
        "https://norbert.wip/assets/controllers/hello_controller.js": "https://norbert.wip/assets/controllers/hello_controller-55882fcad241d2bea50276ea485583bc.js",
        "https://norbert.wip/assets/controllers/clipboard_controller.js": "https://norbert.wip/assets/controllers/clipboard_controller-6aefa8a9dec3271dae2f05b464bf9204.js",
        "https://norbert.wip/assets/controllers/syntax_highlight_controller.js": "https://norbert.wip/assets/controllers/syntax_highlight_controller-ae10e4cee8b4dedbf232536d05654062.js",
        "highlight.js/lib/core": "https://norbert.wip/assets/vendor/highlight.js/lib/core-a4e70e8d9019e717dfd018057650e566.js",
        "highlight.js/lib/languages/php": "https://norbert.wip/assets/vendor/highlight.js/lib/languages/php-3082801e8bbfa191b25e190b817c8690.js",
        "highlight.js/styles/github-dark.min.css": "data:application/javascript,document.head.appendChild%28Object.assign%28document.createElement%28%22link%22%29%2C%7Brel%3A%22stylesheet%22%2Chref%3A%22https%3A%2F%2Fnorbert.wip%2Fassets%2Fvendor%2Fhighlight.js%2Fstyles%2Fgithub-dark.min-4b46e20f66f76e35d6454ca4f09b57c3.css%22%7D%29%29",
        "@fontsource-variable/cabin/index.min.css": "data:application/javascript,document.head.appendChild%28Object.assign%28document.createElement%28%22link%22%29%2C%7Brel%3A%22stylesheet%22%2Chref%3A%22https%3A%2F%2Fnorbert.wip%2Fassets%2Fvendor%2F%40fontsource-variable%2Fcabin%2Findex.min-9c7d0ada22af1e85cec470dbedd33409.css%22%7D%29%29",
        "clipboard": "https://norbert.wip/assets/vendor/clipboard/clipboard.index-dcdefe2499a3b69abd4ab17006bfd09b.js",
        "highlight.js/lib/languages/shell": "https://norbert.wip/assets/vendor/highlight.js/lib/languages/shell-82883b411c0363fd67d4b2a65c9191cd.js",
        "highlight.js/lib/languages/json": "https://norbert.wip/assets/vendor/highlight.js/lib/languages/json-9d4f6cc2ef6373562a0ebc9b0e6fe3c3.js",
        "highlight.js/lib/languages/twig": "https://norbert.wip/assets/vendor/highlight.js/lib/languages/twig-68d52b8a7230c15fca667a4297a37ca5.js",
        "highlight.js/lib/languages/sql": "https://norbert.wip/assets/vendor/highlight.js/lib/languages/sql-ba78665514b9cfeb1e8435f38f0e8ab5.js",
        "highlight.js/lib/languages/javascript": "https://norbert.wip/assets/vendor/highlight.js/lib/languages/javascript-ad36fcdcd285bf2c1bee1fef5dbc226f.js",
        "highlight.js/lib/languages/xml": "https://norbert.wip/assets/vendor/highlight.js/lib/languages/xml-283bc16436bf56d2e1178a8f0b733523.js"
    }
}
</script>
<!-- ES Module Shims: Import maps polyfill for modules browsers without import maps support -->
<script async src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js"></script>
<link rel="modulepreload" href="https://norbert.wip/assets/app-930adf3462cf9ab60908eb1b74cf7ca7.js">
<link rel="modulepreload" href="https://norbert.wip/assets/vendor/@oddbird/popover-polyfill/popover-polyfill.index-8f1adf02d2fe31ba0e133b65d1faeece.js">
<link rel="modulepreload" href="https://norbert.wip/assets/bootstrap-d78d7e12c819dedf89372fb4824c072d.js">
<link rel="modulepreload" href="https://norbert.wip/assets/vendor/htmx.org/htmx.org.index-9c972342e01d7cc4830a1976259158c7.js">
<link rel="modulepreload" href="https://norbert.wip/assets/vendor/iconify-icon/iconify-icon.index-4471e3c6a0bda14753f1327106be2b63.js">
<link rel="modulepreload" href="https://norbert.wip/assets/@symfony/stimulus-bundle/loader-9311b8ea36bad0f6168e687b4d6dee73.js">
<link rel="modulepreload" href="https://norbert.wip/assets/vendor/@hotwired/stimulus/stimulus.index-6f73d85e0fa2bcb3802562288e3f3042.js">
<link rel="modulepreload" href="https://norbert.wip/assets/@symfony/stimulus-bundle/controllers-30e149621baab8220e8ae00cc40a4a23.js">
<link rel="modulepreload" href="https://norbert.wip/assets/controllers/hello_controller-55882fcad241d2bea50276ea485583bc.js">
<script type="module">import 'app';</script>
    </head>
<body class="scroll-smooth text-black relative min-h-screen pb-16">
    <div class="sticky top-0 max-h-screen overflow-y-auto bg-white py-2 px-2 border-b border-gray-500 z-[9999] print:hidden">
        <div class="grid grid-cols-2 sm:mx-auto sm:max-w-screen-2xl md:px-4">
            <div class="text-left">
                <a href="/" class="text-lg">
                    norbert.tech
                </a>
            </div>
            <div class="text-right">
                <a href="/consulting" class="text-lg inline-flex items-center space-x-1 md:mr-4 mr-2">
                    <iconify-icon icon="lineicons:consulting" class="mr-1"></iconify-icon> Consulting
                </a>
                <a href="/blog" class="text-lg inline-flex items-center space-x-1">
                    <iconify-icon icon="ooui:articles-ltr" class="mr-1"></iconify-icon> Blog
                </a>
            </div>
        </div>
    </div>
    
    <main class="mx-auto max-w-screen-2xl mb-4 md:pt-4 px-4 lg:px-0">
            <div class="mx-auto max-w-screen-lg px-2">
        <ul class="mt-2 pl-[20px] flex gap-4">
            <li>
                <a href="/blog" class="text-blue-500 hover:underline">Go Back</a>
            </li>
                    </ul>

            </div>
    <article class="blog-post px-2 py-5 sm:px-4 mx-auto max-w-screen-lg">
        <h1 class="font-bold text-4xl mb-2" id="title">Home Assistant - Accessing Historical Statistics</h1>
<div class="mb-2">
    <small class="text-sm">Posted on August 7, 2024 00:00</small>
</div>
<div class="mb-4">
        <small><span class="badge badge-info">home assistant</span></small>
        <small><span class="badge badge-info">solar installation</span></small>
    </div>
<p>
    One of my favorite integrations in Home Assistant is the integration with the solar installation.
</p>
<p>
    By monitoring electricity production/consumption statistics, I can increase self-consumption by utilizing periods of high production.
</p>
<p>
    Recently, I wanted to build a simple dashboard showing how much net energy (the difference between energy drawn and sent to the grid) I produced on a given day, week, and month.
</p>
<p>
    My inverter provides 2 entities:
</p>
<ul>
    <li>the amount of energy sent to the grid on a given day</li>
    <li>the amount of energy drawn from the grid on a given day</li>
</ul>

<p>
    While daily production wasn't a problem, it was enough to add 2 helpers of the "template" type
</p>
<pre><code class="code-twig" data-controller="syntax-highlight"">{{ float(states("sensor.inverter_solarman_daily_energy_sold")) + (-float(states("sensor.inverter_solarman_daily_energy_bought"))) }}</code></pre>
<p>However, the problem arose when I wanted to access data from the last X days.</p>
<p>
    Several solutions are floating around on the internet, but the simplest and most robust is the solution based on the <a href="https://www.home-assistant.io/integrations/sql/" target="_blank">SQL integration</a>.
</p>
<p>
    Home Assistant uses SQLite as its default database, located at <code class="code-twig">/config/home-assistant_v2.db</code>
</p>
<p>
    Essentially, there are two interesting tables in the database: <code>statistics</code> and <code>statistics_meta</code>.
    Let's prepare a query that will extract the maximum value for each day from a specified date range.
    (In this case, we're looking for the maximum value because the sensors provided by the integration record the energy consumed/returned cumulatively).
</p>
<pre><code class="code-sql" data-controller="syntax-highlight"">SELECT
    ROUND(SUM(max_state), 2) as total
FROM (
    SELECT
    date(statistics.start_ts, 'unixepoch') AS date,
    MAX(statistics.state) AS max_state
    FROM statistics_meta
    LEFT JOIN statistics ON statistics_meta.id = statistics.metadata_id
    WHERE statistics_meta.statistic_id = 'sensor.inverter_solarman_daily_energy_sold'
    GROUP BY date(statistics.start_ts, 'unixepoch')
    ORDER BY date DESC
    LIMIT 7
);</code></pre>

<p>
    Then, all you need to do is search for "SQL" in the list of integrations and configure it accordingly.
</p>

<a href="https://norbert.wip/assets/images/blog/home-assistant-historical-statistics/sql-integration-config-01-04c6b2d8a62824c3c827c60b1401c01a.png" target="_blank" rel="noopener noreferrer">
    <img src="https://norbert.wip/assets/images/blog/home-assistant-historical-statistics/sql-integration-config-01-04c6b2d8a62824c3c827c60b1401c01a.png" alt="Home Assistant SQL Integration" class="w-[460px] rounded-lg shadow-lg my-4">
</a>

<p>
    Repeat this process twice for energy returned/consumed, changing the number of days each time.
    In the end, the SQL integration should provide 4 entities as shown in the screenshot below.
</p>

<a href="https://norbert.wip/assets/images/blog/home-assistant-historical-statistics/sql-integration-preview-01-728e735dab114667f21b701e5a839c6b.png" target="_blank" rel="noopener noreferrer">
    <img src="https://norbert.wip/assets/images/blog/home-assistant-historical-statistics/sql-integration-preview-01-728e735dab114667f21b701e5a839c6b.png" alt="Home Assistant SQL Integration Preview" class="w-[460px] rounded-lg shadow-lg my-4">
</a>

<p>
    Now all we have to do is create 2 helpers under "Settings -> Devices & services -> Helpers" for net energy from the last 7 and 30 days.
</p>

<pre><code class="code-twig" data-controller="syntax-highlight"">{{ float(states('sensor.energy_sent_to_grid_last_7_days')) + (-float(states('sensor.energy_taken_from_grid_last_7_days'))) }}</code></pre>
<pre><code class="code-twig" data-controller="syntax-highlight"">{{ float(states('sensor.energy_sent_to_grid_last_30_days')) + (-float(states('sensor.energy_taken_from_grid_last_30_days'))) }}</code></pre>

<p>
    Done! From now on, we can use all 3 entities to display net energy from the last day/week/month on any chosen dashboard or in automations.
</p>

<a href="https://norbert.wip/assets/images/blog/home-assistant-historical-statistics/energy-dashboard-a55db25e9d49a473b89a2ad3305b8853.png" target="_blank" rel="noopener noreferrer">
    <img src="https://norbert.wip/assets/images/blog/home-assistant-historical-statistics/energy-dashboard-a55db25e9d49a473b89a2ad3305b8853.png" alt="Home Assistant Net Energy Dashboard" class="w-[460px] rounded-lg shadow-lg my-4">
</a>

    </article>
    <div class="mb-2 mx-auto max-w-screen-lg text-center">
        <script src="https://giscus.app/client.js"
                data-repo="norberttech/norbert.tech"
                data-repo-id="MDEwOlJlcG9zaXRvcnkyMjQ0MDQwNDA="
                data-category="Comments"
                data-category-id="DIC_kwDODWAiSM4CionD"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="0"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="light"
                data-lang="en"
                crossorigin="anonymous"
                async>
        </script>
    </div>
    </main>

    <footer class="p-4 bg-sky-50 absolute bottom-0 w-full">
        <div class="mx-auto max-w-screen-2xl text-center">
            <a href="/">by @norbert_tech</a>
        </div>
    </footer>
</body>
</html>